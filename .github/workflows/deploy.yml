name: Build and Deploy Godot 4.5.1 (Windows + Web)

on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout project
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Download Godot binary
      - name: Download Godot 4.5.1
        run: |
          wget https://github.com/godotengine/godot/releases/download/4.5.1-stable/Godot_v4.5.1-stable_linux.x86_64.zip
          unzip Godot_v4.5.1-stable_linux.x86_64.zip
          chmod +x Godot_v4.5.1-stable_linux.x86_64
          sudo mv Godot_v4.5.1-stable_linux.x86_64 /usr/local/bin/godot

      # Step 3: Install export templates
      - name: Install export templates
        run: |
          echo "‚¨áÔ∏è Installing Godot export templates..."
          wget https://github.com/godotengine/godot/releases/download/4.5.1-stable/Godot_v4.5.1-stable_export_templates.tpz -O templates.tpz
          mkdir -p ~/.local/share/godot/export_templates/4.5.1.stable
          unzip -q templates.tpz -d ~/.local/share/godot/export_templates/4.5.1.stable
          if [ -d ~/.local/share/godot/export_templates/4.5.1.stable/templates ]; then
            mv ~/.local/share/godot/export_templates/4.5.1.stable/templates/* ~/.local/share/godot/export_templates/4.5.1.stable/
            rm -rf ~/.local/share/godot/export_templates/4.5.1.stable/templates
          fi
          echo "‚úÖ Templates installed successfully."
          ls -lh ~/.local/share/godot/export_templates/4.5.1.stable

      # Step 4: Verify Godot installation
      - name: Verify Godot installation
        run: godot --version

      # Step 5: Export Windows build
      - name: Export Windows build
        run: |
          echo "üîß Exporting Windows build..."
          mkdir -p build/windows
          godot --headless --path . --verbose --export-release "Windows Desktop" build/windows/tacooz.exe || true
          echo "‚úÖ Windows export complete. Contents:"
          ls -lh build/windows || echo "‚ö†Ô∏è Windows build folder missing!"

      # Step 6: Export Web build
      - name: Export Web build
        run: |
          echo "üîß Exporting Web build..."
          rm -rf build/web
          mkdir -p build/web
          godot --headless --path . --verbose --export-release "Web" build/web/index.html || true
          echo "--- Listing exported web files ---"
          ls -lah build/web || true
          echo "---------------------------------"
          if [ -f "build/web/index.html" ]; then
            echo "‚úÖ Web export succeeded."
          else
            echo "‚ùå ERROR: Web export failed (index.html missing)"
            exit 1
          fi

      # Step 7: Package Web build for itch.io
      - name: Package Web build (flat structure)
        run: |
          echo "üì¶ Creating flat zip for itch.io (no subfolder)..."
          mkdir -p dist
          cd build/web
          # ‰ΩøÁî® -j ÈÄâÈ°πÔºöÊâìÂπ≥ÊâÄÊúâË∑ØÂæÑÔºåËÆ©Êñá‰ª∂Áõ¥Êé•Âú® zip Ê†πÁõÆÂΩï
          zip -j ../../dist/taccoz-html5.zip ./*
          cd ../..
          ls -lh dist
          echo "‚úÖ Packaging complete (flat structure ready for itch.io)."


      # Step 8: Install butler CLI
      - name: Install butler
        run: |
          echo "‚¨áÔ∏è Installing itch.io butler..."
          curl -L -o butler.zip https://broth.itch.ovh/butler/linux-amd64/LATEST/archive/default
          unzip butler.zip -d butler
          sudo mv butler/butler /usr/local/bin/butler
          butler -V

      # Step 9: Upload to itch.io
      - name: Deploy Web build to itch.io
        env:
          BUTLER_API_KEY: ${{ secrets.ITCH_API_KEY }}
        run: |
          echo "üöÄ Uploading to itch.io..."
          butler push dist/taccoz-html5.zip taccoz/taccoz:html5 --userversion $GITHUB_RUN_NUMBER
          echo "‚úÖ Upload complete! Visit your itch.io page to test."
