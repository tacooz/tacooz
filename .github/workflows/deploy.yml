name: Build and Deploy Godot 4.5.1 (Windows + Web)

on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # --- Step 1: Checkout project ---
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- Step 2: Download Godot binary ---
      - name: Download Godot 4.5.1
        run: |
          wget https://github.com/godotengine/godot/releases/download/4.5.1-stable/Godot_v4.5.1-stable_linux.x86_64.zip
          unzip Godot_v4.5.1-stable_linux.x86_64.zip
          chmod +x Godot_v4.5.1-stable_linux.x86_64
          sudo mv Godot_v4.5.1-stable_linux.x86_64 /usr/local/bin/godot

      # --- Step 3: Install export templates ---
      - name: Install export templates
        run: |
          echo "â¬‡ï¸ Installing Godot export templates..."
          wget https://github.com/godotengine/godot/releases/download/4.5.1-stable/Godot_v4.5.1-stable_export_templates.tpz -O templates.tpz
          mkdir -p ~/.local/share/godot/export_templates/4.5.1.stable
          unzip -q templates.tpz -d ~/.local/share/godot/export_templates/4.5.1.stable
          # æœ‰æ—¶å€™è§£å‹åä¼šå‡ºç°åµŒå¥—ç›®å½•ï¼Œéœ€è¦æŠŠå†…å®¹æå‡ä¸€çº§
          if [ -d ~/.local/share/godot/export_templates/4.5.1.stable/templates ]; then
            mv ~/.local/share/godot/export_templates/4.5.1.stable/templates/* ~/.local/share/godot/export_templates/4.5.1.stable/
            rm -rf ~/.local/share/godot/export_templates/4.5.1.stable/templates
          fi
          echo "âœ… Export templates installed. Listing:"
          ls -lh ~/.local/share/godot/export_templates/4.5.1.stable


      # --- Step 4: Verify installation ---
      - name: Verify Godot installation
        run: godot --version

      # --- Step 5: Export Windows build ---
      - name: Export Windows build
        run: |
          echo "ğŸ”§ Exporting Windows build..."
          mkdir -p build/windows
          godot --headless --path . --verbose --export-release "Windows Desktop" build/windows/tacooz.exe
          echo "âœ… Windows export complete. Contents:"
          ls -lh build/windows || echo "âš ï¸ Windows build folder missing!"

      # --- Step 6: Export Web build (safe handling for exit code 1) ---
      - name: Export Web build
        run: |
          echo "ğŸ”§ Exporting Web build (robust handling)..."
          # å…è®¸å‘½ä»¤è¿”å›é0ä¹Ÿç»§ç»­æ‰§è¡Œ
          set +e

          rm -rf build/web
          mkdir -p build/web

          # è¿è¡Œ Godot å¯¼å‡ºå¹¶æ•è·é€€å‡ºç 
          godot --headless --path . --verbose --export-release "Web" build/web/index.html
          GODOT_EXIT_CODE=$?

          # åˆ—å‡ºå¯¼å‡ºäº§ç‰©ï¼ˆæ–¹ä¾¿æ—¥å¿—æ’æŸ¥ï¼‰
          echo "--- Contents of build/web after godot export ---"
          ls -lah build/web || true
          echo "-----------------------------------------------"

          # æ‰‹åŠ¨åˆ¤æ–­å¯¼å‡ºæ˜¯å¦æˆåŠŸï¼ˆindex.html å¿…é¡»å­˜åœ¨ï¼‰
          if [ -f "build/web/index.html" ]; then
            echo "âœ… build/web/index.html found â€” treating export as SUCCESS (Godot exit: ${GODOT_EXIT_CODE})."
            # æ˜ç¡®ä»¥ 0 ç»“æŸæ­¤ stepï¼ˆæ— è®º Godot çš„é€€å‡ºç æ˜¯ä»€ä¹ˆï¼‰
            exit 0
          else
            echo "âŒ build/web/index.html NOT found â€” export FAILED. Godot exit: ${GODOT_EXIT_CODE}"
            # è¿”å›é 0ï¼Œè®©å·¥ä½œæµä¸­æ–­ï¼ˆå› ä¸ºç¡®å®æ²¡äº§ç‰©ï¼‰
            exit 1
          fi


      # --- Step 7: Package Web build (flat zip for itch.io) ---
      - name: Package Web build
        run: |
          echo "ğŸ“¦ Creating flat zip for itch.io..."
          mkdir -p dist
          cd build/web
          zip -r ../../dist/taccoz-html5.zip ./*
          cd ../..
          ls -lh dist
          echo "âœ… Packaging complete."

      # --- Step 8: Install butler CLI ---
      - name: Install butler
        run: |
          echo "â¬‡ï¸ Installing itch.io butler..."
          curl -L -o butler.zip https://broth.itch.ovh/butler/linux-amd64/LATEST/archive/default
          unzip butler.zip -d butler
          sudo mv butler/butler /usr/local/bin/butler
          butler -V

      # --- Step 9: Upload to itch.io ---
      - name: Deploy Web build to itch.io
        env:
          BUTLER_API_KEY: ${{ secrets.ITCH_API_KEY }}
        run: |
          echo "ğŸš€ Uploading to itch.io..."
          butler push dist/taccoz-html5.zip taccoz/taccoz:html5 --userversion $GITHUB_RUN_NUMBER
          echo "âœ… Upload complete! Check your itch.io page for updates."
